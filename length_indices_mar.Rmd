# Length based indices via mar

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)
```


__The flow__:
```
Stations %>%
trim towlength %>%                 # narrow extremes
gather length data %>%
scale by counted %>% 
standardize by towlength %>%       # on the number only
calculate_biomass %>%              # up to now on each length class
summarise_by_station %>%           # now one record per station
                                   # Note statistic up to now is equivalent
                                   #   to afli per tog
                                   # HERE: filter station to use
                                   #       i.e. fixed etc
summarise_by_strata %>%            # one record per strata
summarise                          # one record per year
```

__TO DO__:

* Indices by length class
* Indices when no length measurements, only counts. Possibly use full_join and then set length class to zero where length class not defined.
* User defined grouping?

__Loading needed libraries__:

```{r length_indices_mar}
library(tidyverse)
library(mar)
```

__Some functions__:
```{r}
trim_towlength <- function(d, std.towlength = 4, min.towlength = 2, max.towlength = 8) {
  
  d %>% 
    # seems like one can not refer to same variable twice within one single mutate
    mutate(toglengd = if_else(toglengd > max.towlength, max.towlength, toglengd)) %>% 
    mutate(toglengd = if_else(toglengd < min.towlength, min.towlength, toglengd))
}


gather_length_data <- function(Stations, Species, Length = 0) {
  
  # Here could create an switch, if Stations is connection do below
  #   else read from fjolst
  Lengths <- 
    lesa_lengdir(Stations$src) %>% 
    filter(tegund %in% Species,
           lengd >= Length) %>% 
    group_by(synis_id, tegund, lengd) %>% 
    summarise(fjoldi = sum(fjoldi, na.rm = TRUE)) %>% 
    ungroup()
  
  Counts <-
    lesa_numer(Stations$src) %>% 
    filter(tegund %in% Species) %>% 
    mutate(r =  ifelse(fj_maelt != 0, 1 + fj_talid/fj_maelt, 1)) %>% 
    select(synis_id, tegund, fj_maelt, fj_talid, r)
  
  Stations %>% 
    left_join(Lengths, by = "synis_id") %>% 
    left_join(Counts, by = c("synis_id", "tegund"))
  
}


scale_by_counted <- function(d) {
  d %>% 
    mutate(fjoldi = r * fjoldi / 1e3) %>%   # units of thousan
    select(-r)                              # no use anymore
}

standardise_towlength <- function(d, std.towlength = 4) {
  
  d %>% 
    mutate(N = fjoldi * std.towlength/toglengd) %>%   # standardize to per 4 miles
    select(-toglengd)

}

calculate_biomass <- function(d) {
  
  lwcoeff <- tbl_mar(con, "ops$einarhj.lwcoeff")
  
  d %>% 
    left_join(lwcoeff, by = "tegund") %>% 
    # use Newton's law if lwcoefficient for species not specified
    mutate(a = ifelse(is.na(a), 0.01, a),
           b = ifelse(is.na(b), 3.00, b)) %>% 
    # Below statistic is by length class
    # If include lwcoeff then do a priori a left_join
    mutate(B  = ifelse(is.na(N), 0, N) * a * lengd^b/1e3) %>% 
    select(-a, -b)
  
}

calc_by_strata <- function(d) {
  
  # Stuff should not really be inside this function
  Stratas <- 
  tbl_mar(con, "ops$einarhj.stratas") %>% 
  select(strata, area = rall.area)
    
  d %>% 
    group_by(ar, strata) %>% 
  dplyr::summarise(sN  = n(),   # Number of stations within strata
                   n_m  = mean(N, na.rm = TRUE),
                   n_d  = ifelse(n() == 1, mean(N, na.rm = TRUE) * std.cv, sd(N)),
                   b_m  = mean(B, na.rm = TRUE),
                   b_d  = ifelse(n() == 1, mean(B, na.rm = TRUE) * std.cv, sd(B))) %>% 
  #b_d  = ifelse(N == 1, b_m  * std.cv, stats::sd(b)),
  ungroup() %>%
  left_join(Stratas, by = "strata") %>%
  # within oracle, have to mutate in stages
  mutate(area  = area/1.852^2 / std.area) %>% 
  mutate(n     = n_m  * area,
         b     = b_m  * area)
  
}

aggregate_by_year <- function(d) {
  
  # below equvialent to aggr-calculation
  d %>% 
    group_by(ar) %>%
    # A la HÃ¶ski:
    summarise(n = sum(n, na.rm = TRUE),
              n.cv = pax:::calc_cv(n_m, n_d, area, sN),
              b = sum(b, na.rm = TRUE),
              b.cv = pax:::calc_cv(b_m, b_d, area, sN)) %>% 
    ungroup()
  
}
```

__Run the flow__:
```{r}
LENGTH <- 5 # Index for fish length equal to or larger than
con <- connect_mar()
```

**Get the oldstrata for each smb and store it in Oracle**:
```{r, eval = FALSE}
# NOT RUN
attach("/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Stations.rdata")
smb <- 
  STODVAR.all %>%
  select(synis_id = synis.id, ar, reitur, tognumer, toglengd, strata = oldstrata, lon, lat)
dbWriteTable(con, name = "smbstations", value = smb, overwrite = TRUE)
detach("file:/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Stations.rdata")
```


```{r}
Stations <-  
  tbl(con, "smbstations")
std.cv <- 1
std.area <- 4 * 17/1852
Stations %>%
  trim_towlength() %>% 
  #left_join(Stratas) %>% 
  gather_length_data(Species = 1, Length = LENGTH) %>%
  scale_by_counted() %>% 
  standardise_towlength() %>% 
  calculate_biomass() %>%
  # NOTE: upto here we have data by tow and length
  #       should break the chain here if one were intersted
  #       in catch per station
  #
  # NOTE: next step is the first filtering of stations
  #       
  filter(tognumer %in% 1:39 | is.na(tognumer)) %>%
  group_by(synis_id, ar, strata, tegund) %>% 
  summarise(N = sum(N, na.rm = TRUE),
            B = sum(B, na.rm = TRUE)) %>% 
  # Zero stations
  mutate(N = ifelse(is.na(N), 0, N),
         B = ifelse(is.na(B), 0, B)) %>% 
  calc_by_strata() %>% 
  # Have to collect here because of calc_cv function in the aggregate step
  collect(n = Inf) %>% 
  aggregate_by_year() ->
  d
```

__A double test__:
```{r}
attach("/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Allaggroldsmbindex.rdata")
vatican <- 
  Allaggroldsmbindex %>% 
  filter(species == 1,
         svaedi == "Heild",
         lengd == LENGTH,
         diurnal == 0,
         fixed == 0) %>% 
  select(year = ar, cb = bio.staerri, cb.cv = cv.bio.staerri) %>% 
  mutate(source = "vatican") %>% 
  as_tibble()
detach("file:/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Allaggroldsmbindex.rdata")

d %>% 
  select(year = ar, cb = b, cb.cv = b.cv) %>% 
  mutate(source = "tidy",
         year = year + 0.2) %>% 
  bind_rows(vatican) %>% 
  ggplot(aes(year, cb)) +
  geom_pointrange(aes(ymin = cb * (1 - cb.cv),
                      ymax = cb * (1 + cb.cv),
                      colour = source),
                  lwd = 1) +
  scale_colour_brewer(palette = "Set1") +
  theme(legend.position = c(0.1, 0.8)) +
  labs(x = NULL, y = NULL,
       title = "Biomass indices",
       subtitle = "Comparison of the official (vatican) and tidy")
```
