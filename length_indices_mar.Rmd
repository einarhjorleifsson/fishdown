# Length based indices via mar

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)
```


__The flow__:
```
Stations %>%
trim towlength %>%                 # narrow extremes
gather length data %>%
scale by counted %>% 
standardize by towlength %>%       # on the number only
calculate_biomass %>%              # up to now on each length class
summarise_by_station %>%           # now one record per station
summarise_by_strata %>%            # one record per strata
summarise                          # one record per year
```


__Loading needed libraries__:

```{r length_indices_mar}
library(tidyverse)
library(dplyrOracle)
library(mar)
```

__Some functions__:
```{r}
trim_towlength <- function(d, std.towlength = 4, min.towlength = 2, max.towlength = 8) {
  
  d %>% 
    # seems like one can not refer to same variable twice within one single mutate
    mutate(toglengd = if_else(toglengd > max.towlength, max.towlength, toglengd)) %>% 
    mutate(toglengd = if_else(toglengd < min.towlength, min.towlength, toglengd))
}

standardise_towlength <- function(d, std.towlength = 4) {
  
  d %>% mutate(N = N * std.towlength/toglengd)
  
}

gather_length_data <- function(Stations, Species) {
  
  # Here could create an switch, if Stations is connection do below
  #   else read from fjolst
  Lengths <- 
    lesa_lengdir(Stations$src) %>% 
    filter(tegund %in% Species) %>% 
    group_by(synis_id, tegund, lengd) %>% 
    summarise(fjoldi = sum(fjoldi)) %>% 
    ungroup()
  
  Counts <-
    lesa_numer(Stations$src) %>% 
    filter(tegund %in% Species) %>% 
    mutate(r =  ifelse(fj_maelt != 0, 1 + fj_talid/fj_maelt, 1)) %>% 
    select(synis_id, tegund, fj_maelt, fj_talid, r)
  
  Stations %>% 
    left_join(Lengths, by = "synis_id") %>% 
    left_join(Counts, by = c("synis_id", "tegund"))
  
}

scale_by_counted <- function(d) {
  d %>% 
    mutate(fjoldi = r * fjoldi / 1e3) %>%   # units of thousan
    select(-r)                              # no use anymore
}

standardise_towlength <- function(d, std.towlength = 4) {
  
  d %>% 
    mutate(N = fjoldi * std.towlength/toglengd) %>%   # standardize to per 4 miles
    select(-toglengd)

}


calculate_biomass <- function(d) {
  
  lwcoeff <- tbl_mar(db, "ops$einarhj.lwcoeff")
  
  d %>% 
    left_join(lwcoeff, by = "tegund") %>% 
    # use Newton's law if lwcoefficient for species not specified
    mutate(a = ifelse(is.na(a), 0.01, a),
           b = ifelse(is.na(b), 3.00, b)) %>% 
    # Below statistic is by length class
    # If include lwcoeff then do a priori a left_join
    mutate(B  = ifelse(is.na(N), 0, N) * a * lengd^b/1e3) %>% 
    select(-a, -b)
  
}

calc_by_strata <- function(d) {
  
  # Stuff should not really be inside this function
  Stratas <- 
  tbl_mar(db, "ops$einarhj.stratas") %>% 
  select(strata, area = rall.area)
    
  d %>% 
    group_by(ar, strata) %>% 
  dplyr::summarise(sN  = n(),   # Number of stations within strata
                   n_m  = mean(N),
                   n_d  = ifelse(n() == 1, mean(N) * std.cv, sd(N)),
                   b_m  = mean(B),
                   b_d  = ifelse(n() == 1, mean(B) * std.cv, sd(B))) %>% 
  #b_d  = ifelse(N == 1, b_m  * std.cv, stats::sd(b)),
  ungroup() %>%
  left_join(Stratas, by = "strata") %>%
  # within oracle, have to mutate in stages
  mutate(area  = area/1.852^2 / std.area) %>% 
  mutate(n     = n_m  * area,
         b     = b_m  * area)
  
}

aggregate_by_year <- function(d) {
  
  # below equvialent to aggr-calculation
  d %>% 
    group_by(ar) %>%
    # A la HÃ¶ski:
    summarise(n = sum(n),
              n.cv = pax:::calc_cv(n_m, n_d, area, sN),
              b = sum(b),
              b.cv = pax:::calc_cv(b_m, b_d, area, sN)) %>% 
    ungroup()
  
}
```

__Run the flow__:
```{r}
db <- src_oracle("mar")
Stations <-  tbl_mar(db, "ops$einarhj.smb19852016")


std.cv <- 1
std.area <- 4 * 17/1852
Stations %>%
  trim_towlength() %>% 
  #left_join(Stratas) %>% 
  gather_length_data(Species = 1) %>%
  scale_by_counted() %>% 
  standardise_towlength() %>% 
  calculate_biomass() %>%
  # since not all length classes included can only do the total
  # for the time being to a "verb"
  group_by(synis_id, ar, strata, tegund) %>% 
  summarise(N = sum(N),
            B = sum(B)) %>% 
  # Zero stations
  mutate(N = ifelse(is.na(N), 0, N),
         B = ifelse(is.na(B), 0, B)) %>% 
  calc_by_strata() %>% 
  # Have to collect here because of calc_cv function in the aggregate step
  collect(n = Inf) %>% 
  aggregate_by_year() ->
  d
```

__A double test__:
```{r}
p <- 
  d %>% 
  select(year = ar, cb = b, cb.cv = b.cv) %>% 
  ggplot(aes(year, cb)) +
  geom_pointrange(aes(ymin = cb * (1 - cb.cv),
                      ymax = cb * (1 + cb.cv)),
                  colour = "red", lwd = 1) +
  geom_line(colour = "red", lwd = 1) +
  scale_colour_brewer(palette = "Set1")

attach("/net/hafkaldi/export/u2/reikn/Splus5/SMB/Allindices.RData")
mri <- 
  All.indices %>% 
  filter(species == 1,
         svaedi == "Heild",
         lengd == 5,
         type == "all") %>% 
  select(year = ar, cb = bio.staerri, cb.cv = cv.bio.staerri, type) %>% 
  mutate(source = "mri")
detach("file:/net/hafkaldi/export/u2/reikn/Splus5/SMB/Allindices.RData")
p +
  geom_pointrange(data = mri, 
                  aes(ymin = cb * (1 - cb.cv),
                      ymax = cb * (1 + cb.cv)),
                  colour = "yellow") +
  geom_line(data = mri, colour = "yellow") +
  labs(x = NULL, y = NULL,
       title = "Biomass indices",
       subtitle = "Comparison of the mar (red) and the Bible (grey)")
```
